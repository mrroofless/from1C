//отложенное проведение/обработка документов по ссылке из регистра сведений 
//+ЛаринАА 2017.03.10 ЗНИ ЗНИ RFC-170453 -->
Процедура ОтложенноеПроведение() Экспорт
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	омкОтложенноеПроведениеДокументов.СсылкаНаДокумент,
	|	омкОтложенноеПроведениеДокументов.ОперацияОтложенногоПроведения,
	|	омкОтложенноеПроведениеДокументов.Период
	|ИЗ
	|	РегистрСведений.омкОтложенноеПроведениеДокументов КАК омкОтложенноеПроведениеДокументов";
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		УдалитьСсылку = Ложь;
		Попытка
			НачатьТранзакцию(РежимУправленияБлокировкойДанных.Автоматический);
			
			Если ВыборкаДетальныеЗаписи.ОперацияОтложенногоПроведения  = Справочники.омкОперацииОтложенногоПроведения.ОпределениеКонтрагентаВЗеркальнойВыписке_RFC170453 Тогда
				
				ЗапросПоступления = Новый Запрос;
				ЗапросПоступления.Текст = 
				"ВЫБРАТЬ
				|	ПоступлениеНаРасчетныйСчет.Ссылка
				|ИЗ
				|	Документ.ПоступлениеНаРасчетныйСчет КАК ПоступлениеНаРасчетныйСчет
				|ГДЕ
				|	ПоступлениеНаРасчетныйСчет.НомерВходящегоДокумента = &НомерВходящегоДокумента
				|	И ПоступлениеНаРасчетныйСчет.ДатаВходящегоДокумента = &ДатаВходящегоДокумента
				|	И ПоступлениеНаРасчетныйСчет.Проведен = Истина
				|	И ПоступлениеНаРасчетныйСчет.СуммаДокумента = &СуммаДокумента
				|;
				|	ВЫБРАТЬ
				|	Контрагенты.Ссылка
				|ИЗ
				|	Справочник.Контрагенты КАК Контрагенты
				|ГДЕ
				|	Контрагенты.ОрганизационнаяЕдиница = &ОрганизационнаяЕдиница
				|	И Контрагенты.ИНН = &ИНН
				|	И Контрагенты.МТ_Внутригрупповой = Истина";
				
				ЗапросПоступления.УстановитьПараметр("ДатаВходящегоДокумента", ВыборкаДетальныеЗаписи.СсылкаНаДокумент.ДатаВходящегоДокумента);
				ЗапросПоступления.УстановитьПараметр("НомерВходящегоДокумента", ВыборкаДетальныеЗаписи.СсылкаНаДокумент.НомерВходящегоДокумента);
				ЗапросПоступления.УстановитьПараметр("СуммаДокумента", ВыборкаДетальныеЗаписи.СсылкаНаДокумент.СуммаДокумента);
				ЗапросПоступления.УстановитьПараметр("ИНН", ВыборкаДетальныеЗаписи.СсылкаНаДокумент.Организация.ИНН);
				ЗапросПоступления.УстановитьПараметр("ОрганизационнаяЕдиница", ВыборкаДетальныеЗаписи.СсылкаНаДокумент.Организация);
				
				Рез = ЗапросПоступления.ВыполнитьПакет();
				Если НЕ (Рез[0].Пустой() И Рез[1].Пустой()) Тогда
					
					Выборка = Рез[0].Выбрать();
					
					Пока Выборка.Следующий() Цикл
						ДокПоступление = Выборка.Ссылка.ПолучитьОбъект();
						
						ВыборкаКонтрагент = Рез[1].Выбрать();
						ВыборкаКонтрагент.Следующий();	
						
						ДокПоступление.МТ_Плательщик = ВыборкаКонтрагент.Ссылка;
						ДокПоступление.Контрагент = ВыборкаКонтрагент.Ссылка;
						ДокПоступление.Записать(РежимЗаписиДокумента.Проведение);
						УдалитьСсылку = Истина;						
					КонецЦикла;
				КонецЕсли;
			КонецЕсли;
							
			ЗафиксироватьТранзакцию();
		Исключение
			ОтменитьТранзакцию();
		КонецПопытки;
		
		Если НачалоДня(ВыборкаДетальныеЗаписи.Период) < НачалоДня(ТекущаяДата()) ИЛИ УдалитьСсылку Тогда
			Запись = РегистрыСведений.омкОтложенноеПроведениеДокументов.СоздатьМенеджерЗаписи(); 
			Запись.СсылкаНаДокумент = ВыборкаДетальныеЗаписи.СсылкаНаДокумент;
			Запись.ОперацияОтложенногоПроведения = ВыборкаДетальныеЗаписи.ОперацияОтложенногоПроведения;
			Запись.Период = ВыборкаДетальныеЗаписи.Период;
			Запись.Прочитать();
			Запись.Удалить();
		КонецЕсли;
		
	КонецЦикла;
КонецПроцедуры //-ЛаринАА   <--
